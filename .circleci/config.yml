version: 2.1

jobs:
    build-live:
        docker:
            - image: ubuntu
        steps:
            - run:
                name: build-dependencies
                command: |
                    apt update;
                    apt install -y git rsync;
        
            - checkout

            - add_ssh_keys:
                fingerprints:
                    - "3b:0e:79:7c:c2:3c:2d:d5:db:b4:85:b7:05:0c:ad:d1"

            - run:
                name: build-deploy-live
                command: |
                    rsync -avz --delete -e 'ssh -p 53122 -o StrictHostKeyChecking=no' --omit-dir-times --exclude='.git/' --exclude='.gitignore' --exclude='.circleci/' . circleci@lon3.dustyservers.com:/var/www/henrycole.uk/html/;

    build-staging:
        docker:
            - image: ubuntu
        steps:
            - run:
                name: build-dependencies
                command: |
                    apt update;
                    apt install -y git rsync;
        
            - checkout

            - add_ssh_keys:
                fingerprints:
                    - "12:ba:6c:bd:95:18:47:94:b2:0f:38:38:16:43:f3:a5"

            - run:
                name: build-deploy-staging
                command: |
                    ssh -p 53122 -o StrictHostKeyChecking=no circleci@lon11.dustyservers.com 'docker-compose rm henry-personal-website-staging'
                    rsync -avz --delete -e 'ssh -p 53122 -o StrictHostKeyChecking=no' --omit-dir-times --exclude='.git/' --exclude='.gitignore' --exclude='.circleci/' . circleci@lon11.dustyservers.com:/etc/docker/services/henry-personal-website-staging/srv/;
                    ssh -p 53122 -o StrictHostKeyChecking=no circleci@lon11.dustyservers.com 'docker-compose -f /etc/docker/services/henry-personal-website-staging/docker-compose.yml up -d --force-recreate'
 

workflows:
    do-build:
        jobs:
            - build-live:
                filters:
                    branches:
                        only: 
                            - main
            - build-staging

